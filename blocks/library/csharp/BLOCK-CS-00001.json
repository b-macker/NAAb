{
  "id": "BLOCK-CS-00001",
  "version": "1.0",
  "name": "aspnet_rest_controller",
  "language": "csharp",
  "category": "web_framework",
  "subcategory": null,
  "code": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Caching.Distributed;\nusing System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing System.Text.Json;\n\n[ApiController]\n[Route(\"api/[controller]\")]\n[Authorize]\npublic class ProductsController : ControllerBase\n{\n    private readonly ApplicationDbContext _context;\n    private readonly IDistributedCache _cache;\n    private readonly ILogger<ProductsController> _logger;\n\n    public ProductsController(\n        ApplicationDbContext context,\n        IDistributedCache cache,\n        ILogger<ProductsController> logger)\n    {\n        _context = context;\n        _cache = cache;\n        _logger = logger;\n    }\n\n    [HttpGet]\n    [AllowAnonymous]\n    public async Task<ActionResult<IEnumerable<Product>>> GetProducts(\n        [FromQuery] int page = 1,\n        [FromQuery] int pageSize = 20)\n    {\n        var cacheKey = $\"products_page_{page}_size_{pageSize}\";\n        var cachedData = await _cache.GetStringAsync(cacheKey);\n\n        if (!string.IsNullOrEmpty(cachedData))\n        {\n            var products = JsonSerializer.Deserialize<List<Product>>(cachedData);\n            return Ok(products);\n        }\n\n        var result = await _context.Products\n            .Skip((page - 1) * pageSize)\n            .Take(pageSize)\n            .ToListAsync();\n\n        var serialized = JsonSerializer.Serialize(result);\n        await _cache.SetStringAsync(cacheKey, serialized, new DistributedCacheEntryOptions\n        {\n            AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5)\n        });\n\n        return Ok(result);\n    }\n\n    [HttpGet(\"{id}\")]\n    [AllowAnonymous]\n    public async Task<ActionResult<Product>> GetProduct(Guid id)\n    {\n        var product = await _context.Products.FindAsync(id);\n        if (product == null)\n        {\n            return NotFound(new { message = \"Product not found\" });\n        }\n        return Ok(product);\n    }\n\n    [HttpPost]\n    public async Task<ActionResult<Product>> CreateProduct([FromBody] CreateProductDto dto)\n    {\n        var product = new Product\n        {\n            Name = dto.Name,\n            Description = dto.Description,\n            Price = dto.Price,\n            Stock = dto.Stock,\n            CreatedBy = Guid.Parse(User.FindFirst(\"sub\")?.Value)\n        };\n\n        _context.Products.Add(product);\n        await _context.SaveChangesAsync();\n\n        // Invalidate cache\n        await InvalidateProductCache();\n\n        return CreatedAtAction(nameof(GetProduct), new { id = product.Id }, product);\n    }\n\n    [HttpPut(\"{id}\")]\n    public async Task<IActionResult> UpdateProduct(Guid id, [FromBody] UpdateProductDto dto)\n    {\n        var product = await _context.Products.FindAsync(id);\n        if (product == null)\n        {\n            return NotFound();\n        }\n\n        product.Name = dto.Name ?? product.Name;\n        product.Description = dto.Description ?? product.Description;\n        product.Price = dto.Price ?? product.Price;\n        product.Stock = dto.Stock ?? product.Stock;\n        product.UpdatedAt = DateTime.UtcNow;\n\n        await _context.SaveChangesAsync();\n        await InvalidateProductCache();\n\n        return NoContent();\n    }\n\n    [HttpDelete(\"{id}\")]\n    public async Task<IActionResult> DeleteProduct(Guid id)\n    {\n        var product = await _context.Products.FindAsync(id);\n        if (product == null)\n        {\n            return NotFound();\n        }\n\n        _context.Products.Remove(product);\n        await _context.SaveChangesAsync();\n        await InvalidateProductCache();\n\n        return NoContent();\n    }\n\n    private async Task InvalidateProductCache()\n    {\n        // Simple cache invalidation - remove all product cache keys\n        // In production, use a more sophisticated cache tagging system\n        for (int page = 1; page <= 10; page++)\n        {\n            await _cache.RemoveAsync($\"products_page_{page}_size_20\");\n        }\n    }\n}\n\npublic class CreateProductDto\n{\n    public string Name { get; set; }\n    public string Description { get; set; }\n    public decimal Price { get; set; }\n    public int Stock { get; set; }\n}\n\npublic class UpdateProductDto\n{\n    public string? Name { get; set; }\n    public string? Description { get; set; }\n    public decimal? Price { get; set; }\n    public int? Stock { get; set; }\n}",
  "code_hash": "8fd741d23ccd7ce7f2cf0db757bf2935752f82a5857fe600cdd3a73435232b2e",
  "imports": [
    "Microsoft.AspNetCore.Mvc",
    "Microsoft.EntityFrameworkCore"
  ],
  "exports": {
    "ProductsController": "Controller"
  },
  "parameters": [],
  "dependencies": [],
  "token_count": 1098,
  "times_used": 0,
  "total_tokens_saved": 0,
  "validation_status": "pending",
  "tags": [
    "aspnet",
    "rest",
    "crud",
    "cache",
    "controller"
  ],
  "source_file": null,
  "source_line": null,
  "docstring": "ASP.NET Core REST API controller with caching, pagination, CRUD operations",
  "created_at": "2025-12-13T23:04:27.922897",
  "last_used": null,
  "is_active": true
}