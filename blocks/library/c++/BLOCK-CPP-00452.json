{
  "code": "#include \"spdlog/details/circular_q.h\"\n#include \"spdlog/details/log_msg_buffer.h\"\n#include \"spdlog/details/null_mutex.h\"\n#include \"spdlog/sinks/base_sink.h\"\n#include <mutex>\n#include <string>\n#include <vector>\n\nusing namespace spdlog;\n\nextern \"C\" {\n\nvoid BLOCK-CPP-00452_execute() {\n    {\nnamespace sinks {\n/*\n * Ring buffer sink\n */\ntemplate <typename Mutex>\nclass ringbuffer_sink final : public base_sink<Mutex> {\npublic:\n    explicit ringbuffer_sink(size_t n_items)\n        : q_{n_items} {}\n\n    std::vector<details::log_msg_buffer> last_raw(size_t lim = 0) {\n        std::lock_guard<Mutex> lock(base_sink<Mutex>::mutex_);\n        auto items_available = q_.size();\n        auto n_items = lim > 0 ? (std::min)(lim, items_available) : items_available;\n        std::vector<details::log_msg_buffer> ret;\n        ret.reserve(n_items);\n        for (size_t i = (items_available - n_items); i < items_available; i++) {\n            ret.push_back(q_.at(i));\n        }\n        return ret;\n    }\n\n    std::vector<std::string> last_formatted(size_t lim = 0) {\n        std::lock_guard<Mutex> lock(base_sink<Mutex>::mutex_);\n        auto items_available = q_.size();\n        auto n_items = lim > 0 ? (std::min)(lim, items_available) : items_available;\n        std::vector<std::string> ret;\n        ret.reserve(n_items);\n        for (size_t i = (items_available - n_items); i < items_available; i++) {\n            memory_buf_t formatted;\n            base_sink<Mutex>::formatter_->format(q_.at(i), formatted);\n            ret.push_back(SPDLOG_BUF_TO_STRING(formatted));\n        }\n        return ret;\n    }\n\nprotected:\n    void sink_it_(const details::log_msg &msg) override {\n        q_.push_back(details::log_msg_buffer{msg});\n    }\n    void flush_() override {}\n\nprivate:\n    details::circular_q<details::log_msg_buffer> q_;\n};\n\nusing ringbuffer_sink_mt = ringbuffer_sink<std::mutex>;\nusing ringbuffer_sink_st = ringbuffer_sink<details::null_mutex>;\n\n}  // namespace sinks\n\n}\n}\n\n} // extern \"C\"\n",
  "id": "BLOCK-CPP-00452",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/sinks/ringbuffer_sink.h",
  "source_line": 15,
  "validation_status": "validated"
}