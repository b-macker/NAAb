{
  "code": "{\n private:\n  thousands_sep_result<Char> sep_;\n\n  struct next_state {\n    std::string::const_iterator group;\n    int pos;\n  };\n  next_state initial_state() const { return {sep_.grouping.begin(), 0}; }\n\n  // Returns the next digit group separator position.\n  int next(next_state& state) const {\n    if (!sep_.thousands_sep) return max_value<int>();\n    if (state.group == sep_.grouping.end())\n      return state.pos += sep_.grouping.back();\n    if (*state.group <= 0 || *state.group == max_value<char>())\n      return max_value<int>();\n    state.pos += *state.group++;\n    return state.pos;\n  }\n\n public:\n  explicit digit_grouping(locale_ref loc, bool localized = true) {\n    if (localized)\n      sep_ = thousands_sep<Char>(loc);\n    else\n      sep_.thousands_sep = Char();\n  }\n  explicit digit_grouping(thousands_sep_result<Char> sep) : sep_(sep) {}\n\n  Char separator() const { return sep_.thousands_sep; }\n\n  int count_separators(int num_digits) const {\n    int count = 0;\n    auto state = initial_state();\n    while (num_digits > next(state)) ++count;\n    return count;\n  }\n\n  // Applies grouping to digits and write the output to out.\n  template <typename Out, typename C>\n  Out apply(Out out, basic_string_view<C> digits) const {\n    auto num_digits = static_cast<int>(digits.size());\n    auto separators = basic_memory_buffer<int>();\n    separators.push_back(0);\n    auto state = initial_state();\n    while (int i = next(state)) {\n      if (i >= num_digits) break;\n      separators.push_back(i);\n    }\n    for (int i = 0, sep_index = static_cast<int>(separators.size() - 1);\n         i < num_digits; ++i) {\n      if (num_digits - i == separators[sep_index]) {\n        *out++ = separator();\n        --sep_index;\n      }\n      *out++ = static_cast<Char>(digits[to_unsigned(i)]);\n    }\n    return out;\n  }\n}",
  "id": "BLOCK-CPP-01425",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/fmt/bundled/format.h",
  "source_line": 1931,
  "validation_status": "validated"
}