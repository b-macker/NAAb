{
  "code": "{\nnamespace sinks {\ntemplate <typename ConsoleMutex>\nSPDLOG_INLINE wincolor_sink<ConsoleMutex>::wincolor_sink(void *out_handle, color_mode mode)\n    : out_handle_(out_handle),\n      mutex_(ConsoleMutex::mutex()),\n      formatter_(details::make_unique<spdlog::pattern_formatter>()) {\n    set_color_mode_impl(mode);\n    // set level colors\n    colors_[level::trace] = FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_BLUE;  // white\n    colors_[level::debug] = FOREGROUND_GREEN | FOREGROUND_BLUE;                   // cyan\n    colors_[level::info] = FOREGROUND_GREEN;                                      // green\n    colors_[level::warn] =\n        FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_INTENSITY;  // intense yellow\n    colors_[level::err] = FOREGROUND_RED | FOREGROUND_INTENSITY;   // intense red\n    colors_[level::critical] = BACKGROUND_RED | FOREGROUND_RED | FOREGROUND_GREEN |\n                               FOREGROUND_BLUE |\n                               FOREGROUND_INTENSITY;  // intense white on red background\n    colors_[level::off] = 0;\n}\n\ntemplate <typename ConsoleMutex>\nSPDLOG_INLINE wincolor_sink<ConsoleMutex>::~wincolor_sink() {\n    this->flush();\n}\n\n// change the color for the given level\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::set_color(level::level_enum level,\n                                                          std::uint16_t color) {\n    std::lock_guard<mutex_t> lock(mutex_);\n    colors_[static_cast<size_t>(level)] = color;\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::log(const details::log_msg &msg) {\n    if (out_handle_ == nullptr || out_handle_ == INVALID_HANDLE_VALUE) {\n        return;\n    }\n\n    std::lock_guard<mutex_t> lock(mutex_);\n    msg.color_range_start = 0;\n    msg.color_range_end = 0;\n    memory_buf_t formatted;\n    formatter_->format(msg, formatted);\n    if (should_do_colors_ && msg.color_range_end > msg.color_range_start) {\n        // before color range\n        print_range_(formatted, 0, msg.color_range_start);\n        // in color range\n        auto orig_attribs =\n            static_cast<WORD>(set_foreground_color_(colors_[static_cast<size_t>(msg.level)]));\n        print_range_(formatted, msg.color_range_start, msg.color_range_end);\n        // reset to orig colors\n        ::SetConsoleTextAttribute(static_cast<HANDLE>(out_handle_), orig_attribs);\n        print_range_(formatted, msg.color_range_end, formatted.size());\n    } else  // print without colors if color range is invalid (or color is disabled)\n    {\n        write_to_file_(formatted);\n    }\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::flush() {\n    // windows console always flushed?\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::set_pattern(const std::string &pattern) {\n    std::lock_guard<mutex_t> lock(mutex_);\n    formatter_ = std::unique_ptr<spdlog::formatter>(new pattern_formatter(pattern));\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE\nwincolor_sink<ConsoleMutex>::set_formatter(std::unique_ptr<spdlog::formatter> sink_formatter) {\n    std::lock_guard<mutex_t> lock(mutex_);\n    formatter_ = std::move(sink_formatter);\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::set_color_mode(color_mode mode) {\n    std::lock_guard<mutex_t> lock(mutex_);\n    set_color_mode_impl(mode);\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::set_color_mode_impl(color_mode mode) {\n    if (mode == color_mode::automatic) {\n        // should do colors only if out_handle_  points to actual console.\n        DWORD console_mode;\n        bool in_console = ::GetConsoleMode(static_cast<HANDLE>(out_handle_), &console_mode) != 0;\n        should_do_colors_ = in_console;\n    } else {\n        should_do_colors_ = mode == color_mode::always ? true : false;\n    }\n}\n\n// set foreground color and return the orig console attributes (for resetting later)\ntemplate <typename ConsoleMutex>\nstd::uint16_t SPDLOG_INLINE\nwincolor_sink<ConsoleMutex>::set_foreground_color_(std::uint16_t attribs) {\n    CONSOLE_SCREEN_BUFFER_INFO orig_buffer_info;\n    if (!::GetConsoleScreenBufferInfo(static_cast<HANDLE>(out_handle_), &orig_buffer_info)) {\n        // just return white if failed getting console info\n        return FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_BLUE;\n    }\n\n    // change only the foreground bits (lowest 4 bits)\n    auto new_attribs = static_cast<WORD>(attribs) | (orig_buffer_info.wAttributes & 0xfff0);\n    auto ignored =\n        ::SetConsoleTextAttribute(static_cast<HANDLE>(out_handle_), static_cast<WORD>(new_attribs));\n    (void)(ignored);\n    return static_cast<std::uint16_t>(orig_buffer_info.wAttributes);  // return orig attribs\n}\n\n// print a range of formatted message to console\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::print_range_(const memory_buf_t &formatted,\n                                                             size_t start,\n                                                             size_t end) {\n    if (end > start) {\n        auto size = static_cast<DWORD>(end - start);\n        auto ignored = ::WriteConsoleA(static_cast<HANDLE>(out_handle_), formatted.data() + start,\n                                       size, nullptr, nullptr);\n        (void)(ignored);\n    }\n}\n\ntemplate <typename ConsoleMutex>\nvoid SPDLOG_INLINE wincolor_sink<ConsoleMutex>::write_to_file_(const memory_buf_t &formatted) {\n    auto size = static_cast<DWORD>(formatted.size());\n    DWORD bytes_written = 0;\n    auto ignored = ::WriteFile(static_cast<HANDLE>(out_handle_), formatted.data(), size,\n                               &bytes_written, nullptr);\n    (void)(ignored);\n}\n\n// wincolor_stdout_sink\ntemplate <typename ConsoleMutex>\nSPDLOG_INLINE wincolor_stdout_sink<ConsoleMutex>::wincolor_stdout_sink(color_mode mode)\n    : wincolor_sink<ConsoleMutex>(::GetStdHandle(STD_OUTPUT_HANDLE), mode) {}\n\n// wincolor_stderr_sink\ntemplate <typename ConsoleMutex>\nSPDLOG_INLINE wincolor_stderr_sink<ConsoleMutex>::wincolor_stderr_sink(color_mode mode)\n    : wincolor_sink<ConsoleMutex>(::GetStdHandle(STD_ERROR_HANDLE), mode) {}\n}  // namespace sinks\n}",
  "id": "BLOCK-CPP-00515",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/sinks/wincolor_sink-inl.h",
  "source_line": 16,
  "validation_status": "validated"
}