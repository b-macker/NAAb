{
  "code": "{\nABSL_NAMESPACE_BEGIN\nnamespace flags_internal {\n\nnamespace {\n\n// --------------------------------------------------------------------\n// Returns true if flags defined in the filename should be reported with\n// -helpshort flag.\n\nbool ContainsHelpshortFlags(absl::string_view filename) {\n  // By default we only want flags in binary's main. We expect the main\n  // routine to reside in <program>.cc or <program>-main.cc or\n  // <program>_main.cc, where the <program> is the name of the binary\n  // (without .exe on Windows).\n  auto suffix = flags_internal::Basename(filename);\n  auto program_name = flags_internal::ShortProgramInvocationName();\n  absl::string_view program_name_ref = program_name;\n#if defined(_WIN32)\n  absl::ConsumeSuffix(&program_name_ref, \".exe\");\n#endif\n  if (!absl::ConsumePrefix(&suffix, program_name_ref))\n    return false;\n  return absl::StartsWith(suffix, \".\") || absl::StartsWith(suffix, \"-main.\") ||\n         absl::StartsWith(suffix, \"_main.\");\n}\n\n// --------------------------------------------------------------------\n// Returns true if flags defined in the filename should be reported with\n// -helppackage flag.\n\nbool ContainsHelppackageFlags(absl::string_view filename) {\n  // TODO(rogeeff): implement properly when registry is available.\n  return ContainsHelpshortFlags(filename);\n}\n\n// --------------------------------------------------------------------\n// Generates program version information into supplied output.\n\nstd::string VersionString() {\n  std::string version_str(flags_internal::ShortProgramInvocationName());\n\n  version_str += \"\\n\";\n\n#if !defined(NDEBUG)\n  version_str += \"Debug build (NDEBUG not #defined)\\n\";\n#endif\n\n  return version_str;\n}\n\n// --------------------------------------------------------------------\n// Normalizes the filename specific to the build system/filesystem used.\n\nstd::string NormalizeFilename(absl::string_view filename) {\n  // Skip any leading slashes\n  auto pos = filename.find_first_not_of(\"\\\\/\");\n  if (pos == absl::string_view::npos) return \"\";\n\n  filename.remove_prefix(pos);\n  return std::string(filename);\n}\n\n// --------------------------------------------------------------------\n\nABSL_CONST_INIT absl::Mutex custom_usage_config_guard(absl::kConstInit);\nABSL_CONST_INIT FlagsUsageConfig* custom_usage_config\n    ABSL_GUARDED_BY(custom_usage_config_guard) = nullptr;\n\n}  // namespace\n\nFlagsUsageConfig GetUsageConfig() {\n  absl::MutexLock l(&custom_usage_config_guard);\n\n  if (custom_usage_config) return *custom_usage_config;\n\n  FlagsUsageConfig default_config;\n  default_config.contains_helpshort_flags = &ContainsHelpshortFlags;\n  default_config.contains_help_flags = &ContainsHelppackageFlags;\n  default_config.contains_helppackage_flags = &ContainsHelppackageFlags;\n  default_config.version_string = &VersionString;\n  default_config.normalize_filename = &NormalizeFilename;\n\n  return default_config;\n}\n\nvoid ReportUsageError(absl::string_view msg, bool is_fatal) {\n  std::cerr << \"ERROR: \" << msg << std::endl;\n\n  if (is_fatal) {\n    ABSL_INTERNAL_C_SYMBOL(AbslInternalReportFatalUsageError)(msg);\n  }\n}\n\n}  // namespace flags_internal\n\nvoid SetFlagsUsageConfig(FlagsUsageConfig usage_config) {\n  absl::MutexLock l(&flags_internal::custom_usage_config_guard);\n\n  if (!usage_config.contains_helpshort_flags)\n    usage_config.contains_helpshort_flags =\n        flags_internal::ContainsHelpshortFlags;\n\n  if (!usage_config.contains_help_flags)\n    usage_config.contains_help_flags = flags_internal::ContainsHelppackageFlags;\n\n  if (!usage_config.contains_helppackage_flags)\n    usage_config.contains_helppackage_flags =\n        flags_internal::ContainsHelppackageFlags;\n\n  if (!usage_config.version_string)\n    usage_config.version_string = flags_internal::VersionString;\n\n  if (!usage_config.normalize_filename)\n    usage_config.normalize_filename = flags_internal::NormalizeFilename;\n\n  if (flags_internal::custom_usage_config)\n    *flags_internal::custom_usage_config = usage_config;\n  else\n    flags_internal::custom_usage_config = new FlagsUsageConfig(usage_config);\n}\n\nABSL_NAMESPACE_END\n}",
  "id": "BLOCK-CPP-01751",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/abseil/absl/flags/usage_config.cc",
  "source_line": 42,
  "validation_status": "validated"
}