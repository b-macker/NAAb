{
  "code": "{\n    SourceManager &SourceMgr;\n\n    /// Allocator used to store preprocessing objects.\n    llvm::BumpPtrAllocator BumpAlloc;\n\n    /// The set of preprocessed entities in this record, in order they\n    /// were seen.\n    std::vector<PreprocessedEntity *> PreprocessedEntities;\n\n    /// The set of preprocessed entities in this record that have been\n    /// loaded from external sources.\n    ///\n    /// The entries in this vector are loaded lazily from the external source,\n    /// and are referenced by the iterator using negative indices.\n    std::vector<PreprocessedEntity *> LoadedPreprocessedEntities;\n\n    /// The set of ranges that were skipped by the preprocessor,\n    std::vector<SourceRange> SkippedRanges;\n\n    bool SkippedRangesAllLoaded = true;\n\n    /// Global (loaded or local) ID for a preprocessed entity.\n    /// Negative values are used to indicate preprocessed entities\n    /// loaded from the external source while non-negative values are used to\n    /// indicate preprocessed entities introduced by the current preprocessor.\n    /// Value -1 corresponds to element 0 in the loaded entities vector,\n    /// value -2 corresponds to element 1 in the loaded entities vector, etc.\n    /// Value 0 is an invalid value, the index to local entities is 1-based,\n    /// value 1 corresponds to element 0 in the local entities vector,\n    /// value 2 corresponds to element 1 in the local entities vector, etc.\n    class PPEntityID {\n      friend class PreprocessingRecord;\n\n      int ID = 0;\n\n      explicit PPEntityID(int ID) : ID(ID) {}\n\n    public:\n      PPEntityID() = default;\n    };\n\n    static PPEntityID getPPEntityID(unsigned Index, bool isLoaded) {\n      return isLoaded ? PPEntityID(-int(Index)-1) : PPEntityID(Index+1);\n    }\n\n    /// Mapping from MacroInfo structures to their definitions.\n    llvm::DenseMap<const MacroInfo *, MacroDefinitionRecord *> MacroDefinitions;\n\n    /// External source of preprocessed entities.\n    ExternalPreprocessingRecordSource *ExternalSource = nullptr;\n\n    /// Retrieve the preprocessed entity at the given ID.\n    PreprocessedEntity *getPreprocessedEntity(PPEntityID PPID);\n\n    /// Retrieve the loaded preprocessed entity at the given index.\n    PreprocessedEntity *getLoadedPreprocessedEntity(unsigned Index);\n\n    /// Determine the number of preprocessed entities that were\n    /// loaded (or can be loaded) from an external source.\n    unsigned getNumLoadedPreprocessedEntities() const {\n      return LoadedPreprocessedEntities.size();\n    }\n\n    /// Returns a pair of [Begin, End) indices of local preprocessed\n    /// entities that \\p Range encompasses.\n    std::pair<unsigned, unsigned>\n      findLocalPreprocessedEntitiesInRange(SourceRange Range) const;\n    unsigned findBeginLocalPreprocessedEntity(SourceLocation Loc) const;\n    unsigned findEndLocalPreprocessedEntity(SourceLocation Loc) const;\n\n    /// Allocate space for a new set of loaded preprocessed entities.\n    ///\n    /// \\returns The index into the set of loaded preprocessed entities, which\n    /// corresponds to the first newly-allocated entity.\n    unsigned allocateLoadedEntities(unsigned NumEntities);\n\n    /// Allocate space for a new set of loaded preprocessed skipped\n    /// ranges.\n    ///\n    /// \\returns The index into the set of loaded preprocessed ranges, which\n    /// corresponds to the first newly-allocated range.\n    unsigned allocateSkippedRanges(unsigned NumRanges);\n\n    /// Ensures that all external skipped ranges have been loaded.\n    void ensureSkippedRangesLoaded();\n\n    /// Register a new macro definition.\n    void RegisterMacroDefinition(MacroInfo *Macro, MacroDefinitionRecord *Def);\n\n  public:\n    /// Construct a new preprocessing record.\n    explicit PreprocessingRecord(SourceManager &SM);\n\n    /// Allocate memory in the preprocessing record.\n    void *Allocate(unsigned Size, unsigned Align = 8) {\n      return BumpAlloc.Allocate(Size, Align);\n    }\n\n    /// Deallocate memory in the preprocessing record.\n    void Deallocate(void *Ptr) {}\n\n    size_t getTotalMemory() const;\n\n    SourceManager &getSourceManager() const { return SourceMgr; }\n\n    /// Iteration over the preprocessed entities.\n    ///\n    /// In a complete iteration, the iterator walks the range [-M, N),\n    /// where negative values are used to indicate preprocessed entities\n    /// loaded from the external source while non-negative values are used to\n    /// indicate preprocessed entities introduced by the current preprocessor.\n    /// However, to provide iteration in source order (for, e.g., chained\n    /// precompiled headers), dereferencing the iterator flips the negative\n    /// values (corresponding to loaded entities), so that position -M\n    /// corresponds to element 0 in the loaded entities vector, position -M+1\n    /// corresponds to element 1 in the loaded entities vector, etc. This\n    /// gives us a reasonably efficient, source-order walk.\n    ///\n    /// We define this as a wrapping iterator around an int. The\n    /// iterator_adaptor_base class forwards the iterator methods to basic\n    /// integer arithmetic.\n    class iterator : public llvm::iterator_adaptor_base<\n                         iterator, int, std::random_access_iterator_tag,\n                         PreprocessedEntity *, int, PreprocessedEntity *,\n                         PreprocessedEntity *> {\n      friend class PreprocessingRecord;\n\n      PreprocessingRecord *Self;\n\n      iterator(PreprocessingRecord *Self, int Position)\n          : iterator::iterator_adaptor_base(Position), Self(Self) {}\n\n    public:\n      iterator() : iterator(nullptr, 0) {}\n\n      PreprocessedEntity *operator*() const {\n        bool isLoaded = this->I < 0;\n        unsigned Index = isLoaded ?\n            Self->LoadedPreprocessedEntities.size() + this->I : this->I;\n        PPEntityID ID = Self->getPPEntityID(Index, isLoaded);\n        return Self->getPreprocessedEntity(ID);\n      }\n      PreprocessedEntity *operator->() const { return **this; }\n    };\n\n    /// Begin iterator for all preprocessed entities.\n    iterator begin() {\n      return iterator(this, -(int)LoadedPreprocessedEntities.size());\n    }\n\n    /// End iterator for all preprocessed entities.\n    iterator end() {\n      return iterator(this, PreprocessedEntities.size());\n    }\n\n    /// Begin iterator for local, non-loaded, preprocessed entities.\n    iterator local_begin() {\n      return iterator(this, 0);\n    }\n\n    /// End iterator for local, non-loaded, preprocessed entities.\n    iterator local_end() {\n      return iterator(this, PreprocessedEntities.size());\n    }\n\n    /// iterator range for the given range of loaded\n    /// preprocessed entities.\n    llvm::iterator_range<iterator> getIteratorsForLoadedRange(unsigned start,\n                                                              unsigned count) {\n      unsigned end = start + count;\n      assert(end <= LoadedPreprocessedEntities.size());\n      return llvm::make_range(\n          iterator(this, int(start) - LoadedPreprocessedEntities.size()),\n          iterator(this, int(end) - LoadedPreprocessedEntities.size()));\n    }\n\n    /// Returns a range of preprocessed entities that source range \\p R\n    /// encompasses.\n    ///\n    /// \\param R the range to look for preprocessed entities.\n    llvm::iterator_range<iterator>\n    getPreprocessedEntitiesInRange(SourceRange R);\n\n    /// Returns true if the preprocessed entity that \\p PPEI iterator\n    /// points to is coming from the file \\p FID.\n    ///\n    /// Can be used to avoid implicit deserializations of preallocated\n    /// preprocessed entities if we only care about entities of a specific file\n    /// and not from files \\#included in the range given at\n    /// \\see getPreprocessedEntitiesInRange.\n    bool isEntityInFileID(iterator PPEI, FileID FID);\n\n    /// Add a new preprocessed entity to this record.\n    PPEntityID addPreprocessedEntity(PreprocessedEntity *Entity);\n\n    /// Set the external source for preprocessed entities.\n    void SetExternalSource(ExternalPreprocessingRecordSource &Source);\n\n    /// Retrieve the external source for preprocessed entities.\n    ExternalPreprocessingRecordSource *getExternalSource() const {\n      return ExternalSource;\n    }\n\n    /// Retrieve the macro definition that corresponds to the given\n    /// \\c MacroInfo.\n    MacroDefinitionRecord *findMacroDefinition(const MacroInfo *MI);\n\n    /// Retrieve all ranges that got skipped while preprocessing.\n    const std::vector<SourceRange> &getSkippedRanges() {\n      ensureSkippedRangesLoaded();\n      return SkippedRanges;\n    }\n\n  private:\n    friend class ASTReader;\n    friend class ASTWriter;\n\n    void MacroExpands(const Token &Id, const MacroDefinition &MD,\n                      SourceRange Range, const MacroArgs *Args) override;\n    void MacroDefined(const Token &Id, const MacroDirective *MD) override;\n    void MacroUndefined(const Token &Id, const MacroDefinition &MD,\n                        const MacroDirective *Undef) override;\n    void InclusionDirective(SourceLocation HashLoc, const Token &IncludeTok,\n                            StringRef FileName, bool IsAngled,\n                            CharSourceRange FilenameRange,\n                            OptionalFileEntryRef File, StringRef SearchPath,\n                            StringRef RelativePath, const Module *Imported,\n                            SrcMgr::CharacteristicKind FileType) override;\n    void Ifdef(SourceLocation Loc, const Token &MacroNameTok,\n               const MacroDefinition &MD) override;\n    void Ifndef(SourceLocation Loc, const Token &MacroNameTok,\n                const MacroDefinition &MD) override;\n\n    using PPCallbacks::Elifdef;\n    using PPCallbacks::Elifndef;\n    void Elifdef(SourceLocation Loc, const Token &MacroNameTok,\n                 const MacroDefinition &MD) override;\n    void Elifndef(SourceLocation Loc, const Token &MacroNameTok,\n                  const MacroDefinition &MD) override;\n\n    /// Hook called whenever the 'defined' operator is seen.\n    void Defined(const Token &MacroNameTok, const MacroDefinition &MD,\n                 SourceRange Range) override;\n\n    void SourceRangeSkipped(SourceRange Range,\n                            SourceLocation EndifLoc) override;\n\n    void addMacroExpansion(const Token &Id, const MacroInfo *MI,\n                           SourceRange Range);\n\n    /// Cached result of the last \\see getPreprocessedEntitiesInRange\n    /// query.\n    struct {\n      SourceRange Range;\n      std::pair<int, int> Result;\n    } CachedRangeQuery;\n\n    std::pair<int, int> getPreprocessedEntitiesInRangeSlow(SourceRange R);\n  }",
  "id": "BLOCK-CPP-18921",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/llvm/clang/include/clang/Lex/PreprocessingRecord.h",
  "source_line": 305,
  "validation_status": "validated"
}