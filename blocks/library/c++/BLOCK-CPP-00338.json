{
  "code": "{\nclass udp_client {\n    static constexpr int TX_BUFFER_SIZE = 1024 * 10;\n    SOCKET socket_ = INVALID_SOCKET;\n    sockaddr_in addr_ = {};\n\n    static void init_winsock_() {\n        WSADATA wsaData;\n        auto rv = ::WSAStartup(MAKEWORD(2, 2), &wsaData);\n        if (rv != 0) {\n            throw_winsock_error_(\"WSAStartup failed\", ::WSAGetLastError());\n        }\n    }\n\n    static void throw_winsock_error_(const std::string &msg, int last_error) {\n        char buf[512];\n        ::FormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS, NULL,\n                         last_error, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), buf,\n                         (sizeof(buf) / sizeof(char)), NULL);\n\n        throw_spdlog_ex(fmt_lib::format(\"udp_sink - {}: {}\", msg, buf));\n    }\n\n    void cleanup_() {\n        if (socket_ != INVALID_SOCKET) {\n            ::closesocket(socket_);\n        }\n        socket_ = INVALID_SOCKET;\n        ::WSACleanup();\n    }\n\npublic:\n    udp_client(const std::string &host, uint16_t port) {\n        init_winsock_();\n\n        addr_.sin_family = PF_INET;\n        addr_.sin_port = htons(port);\n        addr_.sin_addr.s_addr = INADDR_ANY;\n        if (InetPtonA(PF_INET, host.c_str(), &addr_.sin_addr.s_addr) != 1) {\n            int last_error = ::WSAGetLastError();\n            ::WSACleanup();\n            throw_winsock_error_(\"error: Invalid address!\", last_error);\n        }\n\n        socket_ = ::socket(PF_INET, SOCK_DGRAM, 0);\n        if (socket_ == INVALID_SOCKET) {\n            int last_error = ::WSAGetLastError();\n            ::WSACleanup();\n            throw_winsock_error_(\"error: Create Socket failed\", last_error);\n        }\n\n        int option_value = TX_BUFFER_SIZE;\n        if (::setsockopt(socket_, SOL_SOCKET, SO_SNDBUF,\n                         reinterpret_cast<const char *>(&option_value), sizeof(option_value)) < 0) {\n            int last_error = ::WSAGetLastError();\n            cleanup_();\n            throw_winsock_error_(\"error: setsockopt(SO_SNDBUF) Failed!\", last_error);\n        }\n    }\n\n    ~udp_client() { cleanup_(); }\n\n    SOCKET fd() const { return socket_; }\n\n    void send(const char *data, size_t n_bytes) {\n        socklen_t tolen = sizeof(struct sockaddr);\n        if (::sendto(socket_, data, static_cast<int>(n_bytes), 0, (struct sockaddr *)&addr_,\n                     tolen) == -1) {\n            throw_spdlog_ex(\"sendto(2) failed\", errno);\n        }\n    }\n};\n}",
  "id": "BLOCK-CPP-00338",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/details/udp_client-windows.h",
  "source_line": 25,
  "validation_status": "validated"
}