{
  "code": "#include <spdlog/details/null_mutex.h>\n#include <spdlog/details/synchronous_factory.h>\n#include <spdlog/sinks/base_sink.h>\n#include <array>\n#include <string>\n#include <syslog.h>\n\nusing namespace spdlog;\n\nextern \"C\" {\n\nvoid BLOCK-CPP-00483_execute() {\n    {\nnamespace sinks {\n/**\n * Sink that write to syslog using the `syscall()` library call.\n */\ntemplate <typename Mutex>\nclass syslog_sink : public base_sink<Mutex> {\npublic:\n    syslog_sink(std::string ident, int syslog_option, int syslog_facility, bool enable_formatting)\n        : enable_formatting_{enable_formatting},\n          syslog_levels_{{/* spdlog::level::trace      */ LOG_DEBUG,\n                          /* spdlog::level::debug      */ LOG_DEBUG,\n                          /* spdlog::level::info       */ LOG_INFO,\n                          /* spdlog::level::warn       */ LOG_WARNING,\n                          /* spdlog::level::err        */ LOG_ERR,\n                          /* spdlog::level::critical   */ LOG_CRIT,\n                          /* spdlog::level::off        */ LOG_INFO}},\n          ident_{std::move(ident)} {\n        // set ident to be program name if empty\n        ::openlog(ident_.empty() ? nullptr : ident_.c_str(), syslog_option, syslog_facility);\n    }\n\n    ~syslog_sink() override { ::closelog(); }\n\n    syslog_sink(const syslog_sink &) = delete;\n    syslog_sink &operator=(const syslog_sink &) = delete;\n\nprotected:\n    void sink_it_(const details::log_msg &msg) override {\n        string_view_t payload;\n        memory_buf_t formatted;\n        if (enable_formatting_) {\n            base_sink<Mutex>::formatter_->format(msg, formatted);\n            payload = string_view_t(formatted.data(), formatted.size());\n        } else {\n            payload = msg.payload;\n        }\n\n        size_t length = payload.size();\n        // limit to max int\n        if (length > static_cast<size_t>(std::numeric_limits<int>::max())) {\n            length = static_cast<size_t>(std::numeric_limits<int>::max());\n        }\n\n        ::syslog(syslog_prio_from_level(msg), \"%.*s\", static_cast<int>(length), payload.data());\n    }\n\n    void flush_() override {}\n    bool enable_formatting_ = false;\n\n    //\n    // Simply maps spdlog's log level to syslog priority level.\n    //\n    int syslog_prio_from_level(const details::log_msg &msg) const {\n        return syslog_levels_.at(static_cast<levels_array::size_type>(msg.level));\n    }\n\nprivate:\n    using levels_array = std::array<int, 7>;\n    levels_array syslog_levels_;\n    // must store the ident because the man says openlog might use the pointer as\n    // is and not a string copy\n    const std::string ident_;\n};\n\nusing syslog_sink_mt = syslog_sink<std::mutex>;\nusing syslog_sink_st = syslog_sink<details::null_mutex>;\n}  // namespace sinks\n\n// Create and register a syslog logger\ntemplate <typename Factory = spdlog::synchronous_factory>\ninline std::shared_ptr<logger> syslog_logger_mt(const std::string &logger_name,\n                                                const std::string &syslog_ident = \"\",\n                                                int syslog_option = 0,\n                                                int syslog_facility = LOG_USER,\n                                                bool enable_formatting = false) {\n    return Factory::template create<sinks::syslog_sink_mt>(logger_name, syslog_ident, syslog_option,\n                                                           syslog_facility, enable_formatting);\n}\n\ntemplate <typename Factory = spdlog::synchronous_factory>\ninline std::shared_ptr<logger> syslog_logger_st(const std::string &logger_name,\n                                                const std::string &syslog_ident = \"\",\n                                                int syslog_option = 0,\n                                                int syslog_facility = LOG_USER,\n                                                bool enable_formatting = false) {\n    return Factory::template create<sinks::syslog_sink_st>(logger_name, syslog_ident, syslog_option,\n                                                           syslog_facility, enable_formatting);\n}\n}\n}\n\n} // extern \"C\"\n",
  "id": "BLOCK-CPP-00483",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/sinks/syslog_sink.h",
  "source_line": 14,
  "validation_status": "validated"
}