{
  "code": "#include <spdlog/common.h>\n#include <spdlog/details/os.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string>\n#include <windows.h>\n#include <winsock2.h>\n#include <ws2tcpip.h>\n\nusing namespace spdlog;\nusing namespace details;\n\nextern \"C\" {\n\nvoid BLOCK-CPP-00308_execute() {\n    {\n        if (is_connected()) {\n            close();\n        }\n        struct addrinfo hints {};\n        ZeroMemory(&hints, sizeof(hints));\n\n        hints.ai_family = AF_UNSPEC;      // To work with IPv4, IPv6, and so on\n        hints.ai_socktype = SOCK_STREAM;  // TCP\n        hints.ai_flags = AI_NUMERICSERV;  // port passed as as numeric value\n        hints.ai_protocol = 0;\n\n        auto port_str = std::to_string(port);\n        struct addrinfo *addrinfo_result;\n        auto rv = ::getaddrinfo(host.c_str(), port_str.c_str(), &hints, &addrinfo_result);\n        int last_error = 0;\n        if (rv != 0) {\n            last_error = ::WSAGetLastError();\n            WSACleanup();\n            throw_winsock_error_(\"getaddrinfo failed\", last_error);\n        }\n\n        // Try each address until we successfully connect(2).\n\n        for (auto *rp = addrinfo_result; rp != nullptr; rp = rp->ai_next) {\n            socket_ = socket(rp->ai_family, rp->ai_socktype, rp->ai_protocol);\n            if (socket_ == INVALID_SOCKET) {\n                last_error = ::WSAGetLastError();\n                WSACleanup();\n                continue;\n            }\n            if (::connect(socket_, rp->ai_addr, (int)rp->ai_addrlen) == 0) {\n                break;\n            } else {\n                last_error = ::WSAGetLastError();\n                close();\n            }\n        }\n        ::freeaddrinfo(addrinfo_result);\n        if (socket_ == INVALID_SOCKET) {\n            WSACleanup();\n            throw_winsock_error_(\"connect failed\", last_error);\n        }\n\n        // set TCP_NODELAY\n        int enable_flag = 1;\n        ::setsockopt(socket_, IPPROTO_TCP, TCP_NODELAY, reinterpret_cast<char *>(&enable_flag),\n                     sizeof(enable_flag));\n    }\n}\n\n} // extern \"C\"\n",
  "id": "BLOCK-CPP-00308",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/details/tcp_client-windows.h",
  "source_line": 62,
  "validation_status": "validated"
}