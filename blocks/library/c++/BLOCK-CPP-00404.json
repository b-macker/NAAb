{
  "code": "{\ntemplate <typename Mutex>\nclass dup_filter_sink : public dist_sink<Mutex> {\npublic:\n    template <class Rep, class Period>\n    explicit dup_filter_sink(std::chrono::duration<Rep, Period> max_skip_duration,\n                             level::level_enum notification_level = level::info)\n        : max_skip_duration_{max_skip_duration},\n          log_level_{notification_level} {}\n\nprotected:\n    std::chrono::microseconds max_skip_duration_;\n    log_clock::time_point last_msg_time_;\n    std::string last_msg_payload_;\n    size_t skip_counter_ = 0;\n    level::level_enum log_level_;\n\n    void sink_it_(const details::log_msg &msg) override {\n        bool filtered = filter_(msg);\n        if (!filtered) {\n            skip_counter_ += 1;\n            return;\n        }\n\n        // log the \"skipped..\" message\n        if (skip_counter_ > 0) {\n            char buf[64];\n            auto msg_size = ::snprintf(buf, sizeof(buf), \"Skipped %u duplicate messages..\",\n                                       static_cast<unsigned>(skip_counter_));\n            if (msg_size > 0 && static_cast<size_t>(msg_size) < sizeof(buf)) {\n                details::log_msg skipped_msg{msg.source, msg.logger_name, log_level_,\n                                             string_view_t{buf, static_cast<size_t>(msg_size)}};\n                dist_sink<Mutex>::sink_it_(skipped_msg);\n            }\n        }\n\n        // log current message\n        dist_sink<Mutex>::sink_it_(msg);\n        last_msg_time_ = msg.time;\n        skip_counter_ = 0;\n        last_msg_payload_.assign(msg.payload.data(), msg.payload.data() + msg.payload.size());\n    }\n\n    // return whether the log msg should be displayed (true) or skipped (false)\n    bool filter_(const details::log_msg &msg) {\n        auto filter_duration = msg.time - last_msg_time_;\n        return (filter_duration > max_skip_duration_) || (msg.payload != last_msg_payload_);\n    }\n};\n\nusing dup_filter_sink_mt = dup_filter_sink<std::mutex>;\nusing dup_filter_sink_st = dup_filter_sink<details::null_mutex>;\n\n}",
  "id": "BLOCK-CPP-00404",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/spdlog/include/spdlog/sinks/dup_filter_sink.h",
  "source_line": 38,
  "validation_status": "validated"
}