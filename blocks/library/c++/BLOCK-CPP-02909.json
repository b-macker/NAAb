{
  "code": "{\nnamespace {\n\n// The average interval until the next sample. A value of 0 disables profiling\n// while a value of 1 will profile all Cords.\nstd::atomic<int> g_cordz_mean_interval(50000);\n\n}  // namespace\n\n#ifdef ABSL_INTERNAL_CORDZ_ENABLED\n\n// Special negative 'not initialized' per thread value for cordz_next_sample.\nstatic constexpr int64_t kInitCordzNextSample = -1;\n\nABSL_CONST_INIT thread_local int64_t cordz_next_sample = kInitCordzNextSample;\n\n// kIntervalIfDisabled is the number of profile-eligible events need to occur\n// before the code will confirm that cordz is still disabled.\nconstexpr int64_t kIntervalIfDisabled = 1 << 16;\n\nABSL_ATTRIBUTE_NOINLINE bool cordz_should_profile_slow() {\n\n  thread_local absl::profiling_internal::ExponentialBiased\n      exponential_biased_generator;\n  int32_t mean_interval = get_cordz_mean_interval();\n\n  // Check if we disabled profiling. If so, set the next sample to a \"large\"\n  // number to minimize the overhead of the should_profile codepath.\n  if (mean_interval <= 0) {\n    cordz_next_sample = kIntervalIfDisabled;\n    return false;\n  }\n\n  // Check if we're always sampling.\n  if (mean_interval == 1) {\n    cordz_next_sample = 1;\n    return true;\n  }\n\n  if (cordz_next_sample <= 0) {\n    // If first check on current thread, check cordz_should_profile()\n    // again using the created (initial) stride in cordz_next_sample.\n    const bool initialized = cordz_next_sample != kInitCordzNextSample;\n    cordz_next_sample = exponential_biased_generator.GetStride(mean_interval);\n    return initialized || cordz_should_profile();\n  }\n\n  --cordz_next_sample;\n  return false;\n}\n\nvoid cordz_set_next_sample_for_testing(int64_t next_sample) {\n  cordz_next_sample = next_sample;\n}\n\n#endif  // ABSL_INTERNAL_CORDZ_ENABLED\n\nint32_t get_cordz_mean_interval() {\n  return g_cordz_mean_interval.load(std::memory_order_acquire);\n}\n\nvoid set_cordz_mean_interval(int32_t mean_interval) {\n  g_cordz_mean_interval.store(mean_interval, std::memory_order_release);\n}\n\n}",
  "id": "BLOCK-CPP-02909",
  "language": "c++",
  "source_file": "/storage/emulated/0/Download/cpp_codebases/abseil/absl/strings/internal/cordz_functions.cc",
  "source_line": 29,
  "validation_status": "validated"
}