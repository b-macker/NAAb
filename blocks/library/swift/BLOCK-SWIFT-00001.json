{
  "id": "BLOCK-SWIFT-00001",
  "version": "1.0",
  "name": "vapor_rest_controller",
  "language": "swift",
  "category": "web_framework",
  "subcategory": null,
  "code": "import Vapor\nimport Fluent\n\nstruct ProductController: RouteCollection {\n    func boot(routes: RoutesBuilder) throws {\n        let products = routes.grouped(\"api\", \"products\")\n\n        // Public routes\n        products.get(use: index)\n        products.get(\":productID\", use: show)\n\n        // Protected routes\n        let protected = products.grouped(JWTMiddleware())\n        protected.post(use: create)\n        protected.put(\":productID\", use: update)\n        protected.delete(\":productID\", use: delete)\n    }\n\n    // GET /api/products\n    func index(req: Request) async throws -> [Product] {\n        let page = req.query[Int.self, at: \"page\"] ?? 1\n        let per = req.query[Int.self, at: \"per\"] ?? 20\n\n        // Try to get from cache\n        let cacheKey = \"products_page_\\(page)_per_\\(per)\"\n        if let cached = try? await req.redis.get(cacheKey, as: [Product].self) {\n            return cached\n        }\n\n        // Query database\n        let products = try await Product.query(on: req.db)\n            .range((page - 1) * per ..< page * per)\n            .all()\n\n        // Cache for 5 minutes\n        try? await req.redis.set(cacheKey, to: products)\n        try? await req.redis.expire(cacheKey, after: .minutes(5))\n\n        return products\n    }\n\n    // GET /api/products/:id\n    func show(req: Request) async throws -> Product {\n        guard let product = try await Product.find(req.parameters.get(\"productID\"), on: req.db) else {\n            throw Abort(.notFound, reason: \"Product not found\")\n        }\n        return product\n    }\n\n    // POST /api/products\n    func create(req: Request) async throws -> Product {\n        let dto = try req.content.decode(CreateProductDTO.self)\n\n        // Get user from JWT\n        let payload = try req.auth.require(JWTPayload.self)\n\n        let product = Product(\n            name: dto.name,\n            description: dto.description,\n            price: dto.price,\n            stock: dto.stock,\n            createdByID: payload.userID\n        )\n\n        try await product.save(on: req.db)\n\n        // Invalidate cache\n        try? await invalidateProductCache(req: req)\n\n        return product\n    }\n\n    // PUT /api/products/:id\n    func update(req: Request) async throws -> Product {\n        guard let product = try await Product.find(req.parameters.get(\"productID\"), on: req.db) else {\n            throw Abort(.notFound)\n        }\n\n        let dto = try req.content.decode(UpdateProductDTO.self)\n\n        if let name = dto.name { product.name = name }\n        if let description = dto.description { product.description = description }\n        if let price = dto.price { product.price = price }\n        if let stock = dto.stock { product.stock = stock }\n\n        try await product.save(on: req.db)\n        try? await invalidateProductCache(req: req)\n\n        return product\n    }\n\n    // DELETE /api/products/:id\n    func delete(req: Request) async throws -> HTTPStatus {\n        guard let product = try await Product.find(req.parameters.get(\"productID\"), on: req.db) else {\n            throw Abort(.notFound)\n        }\n\n        try await product.delete(on: req.db)\n        try? await invalidateProductCache(req: req)\n\n        return .noContent\n    }\n\n    private func invalidateProductCache(req: Request) async throws {\n        // Simple cache invalidation\n        for page in 1...10 {\n            try? await req.redis.delete(\"products_page_\\(page)_per_20\")\n        }\n    }\n}\n\nstruct CreateProductDTO: Content {\n    let name: String\n    let description: String\n    let price: Double\n    let stock: Int\n}\n\nstruct UpdateProductDTO: Content {\n    let name: String?\n    let description: String?\n    let price: Double?\n    let stock: Int?\n}\n\nstruct JWTPayload: JWTPayload {\n    let userID: UUID\n    let exp: ExpirationClaim\n\n    func verify(using signer: JWTSigner) throws {\n        try exp.verifyNotExpired()\n    }\n}",
  "code_hash": "251dc066117765953b0a65e45d404ee76e48667c3c749169d9daa8d0e0ffd75b",
  "imports": [
    "Vapor",
    "Fluent"
  ],
  "exports": {
    "ProductController": "RouteCollection"
  },
  "parameters": [],
  "dependencies": [],
  "token_count": 966,
  "times_used": 0,
  "total_tokens_saved": 0,
  "validation_status": "pending",
  "tags": [
    "vapor",
    "rest",
    "crud",
    "cache",
    "controller"
  ],
  "source_file": null,
  "source_line": null,
  "docstring": "Vapor REST controller with caching, pagination, CRUD operations",
  "created_at": "2025-12-13T23:05:06.623039",
  "last_used": null,
  "is_active": true
}