// IronDome/modules/protocol_arbiter.naab
// Sovereign Protocol & Contract Guardian
// Uses: <<go>>, <<typescript>>, json, env, string, fabric_utils, file

use io
use json
use env
use string
use fabric_utils
use file

export fn validate_contract(packet_json, expected_schema_type) {
    let tmp_packet = "verification/ch0_full_projects/IronDome/logs/tmp_packet.json"
    file.write(tmp_packet, packet_json)

    // Stage 1: Runtime Integrity Check (Go)
    let runtime_check_raw = <<go[tmp_packet]
    package main
    import ("fmt"; "os"; "encoding/json")
    func main() {
        p, _ := os.ReadFile(tmp_packet)
        var js json.RawMessage
        isValid := json.Unmarshal(p, &js) == nil
        fmt.Printf("{\"is_valid_json\":%t,\"size\":%d}", isValid, len(p))
    }
    >>
    let r_data = fabric_utils.extract_json(runtime_check_raw, "PROTOCOL_ARBITER_GO")

    if r_data == null || !r_data["is_valid_json"] {
        file.delete(tmp_packet)
        throw "PROTOCOL_VIOLATION: Data packet is not valid JSON."
    }

    // Stage 2: Schema Enforcement (TypeScript)
    env.set_var("NAAB_EXPECTED_TYPE", expected_schema_type)
    let schema_validation_raw = <<typescript[tmp_packet]
    const fs = require('fs');
    const packet = fs.readFileSync(tmp_packet, 'utf8');
    const type = (process.env.NAAB_EXPECTED_TYPE || "UNKNOWN").trim();
    const data = JSON.parse(packet);
    const requirements: any = {
        "ENFORCEMENT": ["total_gates", "passed", "violations"],
        "DECISION": ["risk_index", "recommendation"],
        "REMEDIATION": ["patch", "ready_for_apply"]
    };
    const keys = requirements[type] || [];
    const missing = keys.filter((k: string) => data[k] === undefined);
    const res = {
        received_type: type,
        available_keys: Object.keys(data),
        contract_status: missing.length === 0 ? "VALID" : "INVALID",
        missing_keys: missing
    };
    process.stdout.write(JSON.stringify(res));
    >>
    env.delete_var("NAAB_EXPECTED_TYPE")
    file.delete(tmp_packet)
    
    let s_data = fabric_utils.extract_json(schema_validation_raw, "PROTOCOL_ARBITER_TS")

    return {
        "runtime": r_data,
        "contract": s_data,
        "certified": (s_data != null && s_data["contract_status"] == "VALID")
    }
}
