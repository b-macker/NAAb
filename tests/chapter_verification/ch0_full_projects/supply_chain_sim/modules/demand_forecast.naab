// modules/demand_forecast.naab
use json
use io
use array

// We will attempt to import this specific struct using 'import { Forecast } ...'
export struct Forecast {
    product: string,
    region: string,
    predicted_sales: int
}

export fn predict(sales_csv: string) -> list<Forecast> {
    io.write("ğŸ [Python] Forecasting demand...\n")
    
    // Python block to parse CSV and predict
    let json_result = <<python[sales_csv]
import json

lines = sales_csv.strip().split('\n')
data = []
for line in lines[1:]:
    parts = line.split(',')
    if len(parts) == 3:
        data.append({"region": parts[0], "product": parts[1], "sales": int(parts[2])})

forecasts = []
for item in data:
    forecasts.append({
        "product": item["product"],
        "region": item["region"],
        "predicted_sales": int(item["sales"] * 1.1)
    })

json.dumps(forecasts)
    >>

    let parsed_list = json.parse(json_result)
    let results: list<Forecast> = []
    
    let i = 0
    while i < array.length(parsed_list) {
        let item = parsed_list[i]
        results = array.push(results, new Forecast {
            product: item.product,
            region: item.region,
            predicted_sales: item.predicted_sales
        })
        i = i + 1
    }
    
    return results
}
