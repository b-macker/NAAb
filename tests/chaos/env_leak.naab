// verification/chaos_tests/env_leak.naab
// Goal: Test environment variable isolation between NAAb and guest languages.
// NOTE: CPython is embedded in the same process, so os.environ IS shared.
// This is by design — true isolation requires OS-level sandboxing (containers).
use io
use env

main {
    print("--- ENV LEAK TEST ---")
    env.set_var("NAAB_SECRET", "12345")

    // Python shares process environment (embedded CPython)
    let py_check = <<python
import os
val = os.getenv("NAAB_SECRET", "NOT_FOUND")
os.environ["NAAB_SECRET"] = "MODIFIED"
val
>>
    print("Python saw: " + py_check)

    let host_val = env.get("NAAB_SECRET")
    print("Host now sees: " + host_val)

    if host_val == "MODIFIED" {
        print("EXPECTED: Environment shared (embedded CPython shares process)")
        print("NOTE: This is by design — not a bug. True isolation requires containers.")
    } else {
        print("PASS: Environment isolated")
    }

    // Cleanup
    env.set_var("NAAB_SECRET", "")
}
