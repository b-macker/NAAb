// IronDome/modules/readiness_ruby.naab
// Release Readiness Check using Ruby
// Uses: <<ruby>>, json, io

use io
use json

fn ruby_check(logs_path) {
    let result = <<ruby[logs_path]
require 'json'

ready = Dir.exist?(logs_path) && File.writable?(logs_path)

result = {
    "ready": ready,
    "checks": [
        {"name": "logs_dir_exists", "status": Dir.exist?(logs_path)},
        {"name": "logs_dir_writable", "status": File.writable?(logs_path)}
    ],
    "environment": ENV['TERMUX_VERSION'] ? "Termux" : "Unknown"
}
puts JSON.generate(result)
    >>
    
    return json.parse(result)
}

export fn check_readiness(base_dir) {
    io.write("    [Readiness] Final Ruby validation of environment...
")
    let logs_path = base_dir + "/logs"
    return ruby_check(logs_path)
}
