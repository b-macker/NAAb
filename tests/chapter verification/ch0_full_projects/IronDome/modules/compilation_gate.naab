// IronDome/modules/compilation_gate.naab
// Compilation & Syntax Gate
// Uses: <<python>>, json, io

use io
use json

export fn check_compilation(files) {
    let files_json = json.stringify(files)

    let result = <<python[files_json]
import json
import py_compile
import os

files = json.loads(files_json)
failures = []

for f in files:
    path = f["path"]
    if path.endswith(".py"):
        try:
            py_compile.compile(path, doraise=True)
        except Exception as e:
            failures.append({"file": path, "error": str(e)})
    elif path.endswith(".naab"):
        if not os.path.exists(path) or os.path.getsize(path) == 0:
            failures.append({"file": path, "error": "Empty or missing NAAb file"})

res = {
    "success": len(failures) == 0,
    "failure_count": len(failures),
    "failures": failures,
    "checked_count": len(files)
}
json.dumps(res)
    >>

    return json.parse(result)
}
