// modules/notification_service.naab
// Responsible for simulating the sending of alerts and notifications based on detected anomalies.
// Refactored to export a factory function that returns a map of its API.

// (Note: No direct import "modules/logger.naab" here. Configured logger is passed.)

// --- Factory Function: createNotificationServiceModule ---
// This function returns a map of functions that constitute the module's public API.
export func createNotificationServiceModule(): Map<String, Any> {

    // --- Internal Function: init ---
    // Initializes the notification service module with global configuration and configured logger.
    let initFunc = func(globalConfig: Map<String, Any>, configuredLogger: Map<String, Any>) {
        configuredLogger.logInfo("NotificationServiceModule initialized.");
    };

    // --- Internal Function: formatAlertMessage ---
    // Formats a human-readable alert message from anomaly details.
    let formatAlertMessageFunc = func(anomaly: Map<String, Any>, configuredLogger: Map<String, Any>) {
        let level = anomaly.getString("level", "UNKNOWN");
        let metric = anomaly.getString("metric", "Unknown Metric");
        let type = anomaly.getString("type", "Unknown Type");
        let value = anomaly.getString("value", "N/A");
        let threshold = anomaly.getString("threshold", "N/A");

        let getCurrentTimestamp = configuredLogger.getCurrentTimestamp;
        let timestamp = anomaly.getString("data_point_timestamp", getCurrentTimestamp());

        let message = "GEMRS Alert: ${level} - ${metric} ${type} at ${timestamp}\n";
        message += "  Value: ${value}\n";
        message += "  Threshold: ${threshold}\n";

        if anomaly.has("location") {
            message += "  Location: ${anomaly.getString("location")}\n";
        }
        if anomaly.has("city") {
            message += "  City: ${anomaly.getString("city")}\n";
        }

        return message;
    };

    // --- Internal Function: sendEmail (Simulated) ---
    // Simulates sending an email.
    let sendEmailFunc = func(recipient: String, subject: String, body: String, configuredLogger: Map<String, Any>) {
        configuredLogger.logInfo("Simulating email send to: ${recipient}");
        configuredLogger.logInfo("Subject: ${subject}");
        configuredLogger.logInfo("Body: \n${body}");
        return true;
    };

    // --- Internal Function: sendAnomalyAlerts ---
    // Sends alerts for detected anomalies to configured recipients.
    let sendAnomalyAlertsFunc = func(anomalies: List<Map<String, Any>>, notificationConfig: Map<String, Any>, configuredLogger: Map<String, Any>) {
        if (!notificationConfig.getBool("enabled", false)) {
            configuredLogger.logInfo("Notifications are disabled in configuration. Skipping anomaly alerts.");
            return;
        }

        let recipients = notificationConfig.getList("recipients").asList(String);
        let criticalAlertsOnly = notificationConfig.getBool("critical_alerts_only", false);

        if (recipients.isEmpty()) {
            configuredLogger.logWarn("No notification recipients configured. Skipping anomaly alerts.");
            return;
        }

        for anomaly in anomalies {
            let anomalyLevel = anomaly.getString("level", "UNKNOWN");

            if (criticalAlertsOnly && anomalyLevel != "CRITICAL") {
                configuredLogger.logInfo("Skipping non-critical anomaly due to 'critical_alerts_only' setting: ${anomaly.getString("metric")}");
                continue;
            }

            let subject = "GEMRS Environmental Alert: ${anomalyLevel} - ${anomaly.getString("metric")}";
            let body = formatAlertMessageFunc(anomaly, configuredLogger); // Call internal function

            for recipient in recipients {
                if (sendEmailFunc(recipient, subject, body, configuredLogger)) { // Call internal function
                    configuredLogger.logInfo("Anomaly alert sent successfully to ${recipient} for ${anomaly.getString("metric")}.");
                } else {
                    configuredLogger.logError("Failed to send anomaly alert to ${recipient}.", "Email simulation failed.");
                }
            }
        }
    };

    // Return the public API of the module as a map of functions
    return {
        "init": initFunc,
        "sendAnomalyAlerts": sendAnomalyAlertsFunc
    };
}