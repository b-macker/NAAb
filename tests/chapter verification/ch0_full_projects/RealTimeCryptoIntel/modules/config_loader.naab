// modules/config_loader.naab
// Module for loading and managing application configuration

use io
use json
use file
use array // For array.push

// Structs for configuration (matching JSON config)
export struct ConfigApi { base_url: string, timeout_seconds: int }
export struct ConfigAsset { id: string, symbol: string, amount: float, cost_basis: float }
export struct ConfigMonteCarlo {
    num_simulations: int,
    num_days_forecast: int,
    risk_free_rate_annual: float
}

export struct ConfigRisk {
    history_days: int,
    confidence_level: float,
    var_method: string,
    monte_carlo: ConfigMonteCarlo // New field for Monte Carlo settings
}
export struct ConfigReport { output_dir: string, filename: string }

export struct AppConfig {
    api: ConfigApi,
    portfolio: list<ConfigAsset>,
    risk_settings: ConfigRisk,
    reporting: ConfigReport
}

export fn load_config(path: string) -> AppConfig {
    let content = file.read(path)
    let parsed = json.parse(content)
    
    // Manual mapping to structs (Robustness)
    let assets: list<ConfigAsset> = []
    for p in parsed.portfolio {
        array.push(assets, new ConfigAsset {
            id: p.id, symbol: p.symbol, amount: p.amount, cost_basis: p.cost_basis
        })
    }
    
    return new AppConfig {
        api: new ConfigApi { base_url: parsed.api.base_url, timeout_seconds: parsed.api.timeout_seconds },
        portfolio: assets,
        risk_settings: new ConfigRisk { 
            history_days: parsed.risk_settings.history_days, 
            confidence_level: parsed.risk_settings.confidence_level,
            var_method: parsed.risk_settings.var_method,
            monte_carlo: new ConfigMonteCarlo {
                num_simulations: parsed.risk_settings.monte_carlo.num_simulations,
                num_days_forecast: parsed.risk_settings.monte_carlo.num_days_forecast,
                risk_free_rate_annual: parsed.risk_settings.monte_carlo.risk_free_rate_annual
            }
        },
        reporting: new ConfigReport { output_dir: parsed.reporting.output_dir, filename: parsed.reporting.filename }
    }
}
