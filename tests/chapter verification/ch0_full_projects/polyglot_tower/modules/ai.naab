// polyglot_tower/modules/ai.naab
use io
use json
use types

// Define the structure for an AI decision
export struct AIAction {
    action_type: string, // "ATTACK", "DEFEND", "HEAL", "FLEE"
    value: int,          // Damage amount, heal amount, etc.
    message: string      // Flavor text for the action
}

// The core AI function. Takes the enemy and player as JSON, returns an AIAction.
export fn decide_action(enemy_json: string, player_json: string) -> AIAction {
    
    // Python block to run the AI logic
    let decision_json = <<python[enemy_json, player_json]
import json
import random

class EnemyAI:
    def __init__(self, enemy_data, player_data):
        self.enemy = enemy_data
        self.player = player_data
        self.hp_percent = self.enemy['hp'] / self.enemy['max_hp']

    def decide(self):
        # AI Personality Logic
        
        # 1. Critical Health ( < 20% ) -> Try to Heal or Flee
        if self.hp_percent < 0.2:
            if random.random() < 0.7: # 70% chance to try healing
                heal_amt = int(self.enemy['max_hp'] * 0.3)
                return {
                    "action_type": "HEAL",
                    "value": heal_amt,
                    "message": f"{self.enemy['name']} desperately drinks a potion!"
                }
            else:
                return {
                    "action_type": "FLEE",
                    "value": 0,
                    "message": f"{self.enemy['name']} tries to run away!"
                }

        # 2. Player Low Health -> Aggressive
        player_hp_percent = self.player['hp'] / self.player['max_hp']
        if player_hp_percent < 0.3:
            dmg = int(self.enemy['attack'] * 1.5)
            return {
                "action_type": "ATTACK",
                "value": dmg,
                "message": f"{self.enemy['name']} smells blood and attacks viciously!"
            }

        # 3. Standard Behavior -> Attack or Defend
        if random.random() < 0.8: # 80% Attack
            # Normal attack with slight variance
            variance = random.uniform(0.8, 1.2)
            dmg = int(self.enemy['attack'] * variance)
            return {
                "action_type": "ATTACK",
                "value": dmg,
                "message": f"{self.enemy['name']} attacks you."
            }
        else: # 20% Defend
            block_amt = int(self.enemy['attack'] * 0.5)
            return {
                "action_type": "DEFEND",
                "value": block_amt,
                "message": f"{self.enemy['name']} raises its guard."
            }

# Deserialize inputs
enemy = json.loads(enemy_json)
player = json.loads(player_json)

# Run AI
ai = EnemyAI(enemy, player)
result = ai.decide()

# Return result as JSON string
json.dumps(result)
    >>

    // Parse the result back into a NAAb struct
    let parsed = json.parse(decision_json)
    
    return new AIAction {
        action_type: parsed["action_type"],
        value: parsed["value"],
        message: parsed["message"]
    }
}
