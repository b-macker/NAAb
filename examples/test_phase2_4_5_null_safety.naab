// Phase 2.4.5: Null Safety Tests
// Testing non-nullable by default with explicit nullable types

// Test 1: Non-nullable types
fn testNonNullable() {
    print("\n[Test 1] Non-nullable types (safe by default)")

    let x: int = 42
    print("x = ", x)  // ✅ Works

    let name: string = "Alice"
    print("name = ", name)  // ✅ Works

    // These should error at runtime:
    // let y: int = null       // ❌ ERROR: Cannot assign null to non-nullable
    // let z: string = null    // ❌ ERROR: Cannot assign null to non-nullable
}

// Test 2: Nullable types
fn testNullable() {
    print("\n[Test 2] Nullable types (explicit with ?)")

    let x: int? = null
    print("x is null")  // ✅ Works

    x = 42
    print("x = ", x)  // ✅ Works

    let name: string? = "Bob"
    print("name = ", name)  // ✅ Works

    name = null
    print("name is now null")  // ✅ Works
}

// Test 3: Function parameters
fn greet(name: string) {
    print("Hello, ", name)
}

fn greetMaybe(name: string?) {
    if (typeof(name) == "string") {
        print("Hello, ", name)
    } else {
        print("Hello, stranger")
    }
}

fn testParameters() {
    print("\n[Test 3] Function parameters")

    greet("Alice")  // ✅ Works
    // greet(null)  // ❌ ERROR: Cannot pass null to non-nullable parameter

    greetMaybe("Bob")  // ✅ Works
    greetMaybe(null)   // ✅ Works - parameter is nullable
}

// Test 4: Return types
fn getValue() -> int {
    return 42
    // return null  // ❌ ERROR: Cannot return null from non-nullable function
}

fn getNullable() -> int? {
    return null  // ✅ Works - return type is nullable
}

fn testReturns() {
    print("\n[Test 4] Return types")

    let val1 = getValue()
    print("getValue() = ", val1)

    let val2 = getNullable()
    print("getNullable() is null")
}

// Test 5: Type annotations in error messages
fn testErrorMessages() {
    print("\n[Test 5] Nullable type annotations (int? vs int)")

    let nullable: int? = 42
    print("nullable: int? = ", nullable)

    nullable = null
    print("nullable: int? = null")

    let nonnull: int = 123
    print("nonnull: int = ", nonnull)
}

main {
    print("=== Phase 2.4.5: Null Safety Tests ===")
    print("Testing non-nullable by default with ? for nullable types")

    testNonNullable()
    testNullable()
    testParameters()
    testReturns()
    testErrorMessages()

    print("\n=== All tests passed! ===")
    print("\nKey takeaways:")
    print("  - Types are non-nullable by default (safe)")
    print("  - Use ? to make a type nullable (int? means nullable int)")
    print("  - Cannot assign/pass/return null to non-nullable types")
    print("  - Error messages show type? for nullable types")
}
