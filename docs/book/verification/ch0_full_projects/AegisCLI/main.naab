// ===================================================================
// AEGIS-CLI: Automated Engineering Guidance & Intelligence System
// ===================================================================
//
// A polyglot terminal assistant that uses:
// - NAAb for orchestration
// - Python for LLM logic
// - Rust for high-speed file scanning
// - Bash for system commands
// - JavaScript for UI rendering
//
// ===================================================================

use io
use json
use file
use env
use array
use string
use time

// ── Modules ──────────────────────────────────────────────────────
use modules.config_loader
use modules.ui_renderer
use modules.scanner
use modules.intelligence
use modules.executor

// ── Constants ────────────────────────────────────────────────────
const APP_NAME = "Aegis-CLI"
const VERSION = "1.0.0"
const CONFIG_DIR = ".aegis"
const CONFIG_FILE = "config.json"

// ── Main Entry Point ─────────────────────────────────────────────
main {
    // 1. Initialize UI
    ui_renderer.print_banner(APP_NAME, VERSION)

    // 2. Load Configuration
    let home = env.get("HOME")
    let config_path = home + "/" + CONFIG_DIR + "/" + CONFIG_FILE
    
    let config = {}
    try {
        config = config_loader.load_config(config_path)
        io.write("  [Config] Loaded from ", config_path, "\n")
    } catch (e) {
        ui_renderer.print_warning("Config not found or invalid. Starting setup wizard...")
        config = config_loader.run_setup_wizard(config_path)
    }

    // 3. Initialize Components
    let scanner = scanner.init(config)
    let intel = intelligence.init(config)
    let exec = executor.init(config)

    // 4. Start REPL Loop
    ui_renderer.print_success("System initialized. Ready for commands.")
    ui_renderer.print_info("Type '/help' for commands or just ask a question.")

    let running = true
    while running {
        let prompt_text = ui_renderer.get_prompt_string()
        io.write(prompt_text)
        
        // Simulating read_line (since io.read_line might not be fully interactive in all envs)
        // Ideally this would be: let input = io.read_line()
        // For now, let's assume arguments or a dummy loop for the plan demonstration
        let input = "/exit" // Placeholder for now
        
        if input == "/exit" {
            running = false
        } else {
            // Process command
            if string.starts_with(input, "/") {
                // Command dispatch
                if input == "/scan" {
                    scanner.scan_workspace(".")
                } else if input == "/help" {
                    ui_renderer.print_help()
                } else {
                    ui_renderer.print_error("Unknown command: " + input)
                }
            } else {
                // LLM Query
                let context = scanner.get_context()
                let response = intel.ask(input, context)
                ui_renderer.render_markdown(response)
            }
        }
    }

    ui_renderer.print_info("Shutting down. Goodbye!")
}
