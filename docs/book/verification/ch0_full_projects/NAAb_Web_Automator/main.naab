// NAAb_Web_Automator/main.naab
// Main entry point for the NAAb Web Automation & Data Extraction Platform

use io // Standard library for input/output
use json // For pretty printing
use modules.web_automator_core as core // Core configuration and helper functions
use modules.scraper_py as scraper // Playwright integration

main {
    io.write("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
    io.write("â•‘       NAAb Web Automation & Data Extraction Platform       â•‘\n")
    io.write("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

    io.write("Platform initialized. Loading configuration...\n")

    let config_file_path = "docs/book/verification/ch0_full_projects/NAAb_Web_Automator/config/automator_config.json"
    let automator_config: core.AutomatorConfig? = core.load_config(config_file_path)

    if automator_config == null {
        io.write_error("âŒ Failed to load configuration from ", config_file_path, ". Aborting.\n")
        return
    }
    io.write("âœ“ Configuration loaded successfully.\n\n")

    let browser_context_id: string? = null
    try {
        io.write("ğŸš€ Initializing browser...\n")
        browser_context_id = scraper.init_browser(automator_config.browser_settings)
        if browser_context_id == null {
            throw "Failed to initialize browser."
        }
        io.write("âœ“ Browser initialized. Context ID: ", browser_context_id, "\n\n")

        io.write("â–¶ï¸ Starting automation flows...\n")
        let flow_index = 0
        while flow_index < array.length(automator_config.flows) {
            let current_flow = automator_config.flows[flow_index]
            io.write("  Executing flow: ", current_flow.name, " (", current_flow.start_url, ")\n")

            let flow_results = scraper.execute_web_flow(browser_context_id, current_flow)
            
            if flow_results != null {
                let scraped_items = flow_results["scraped_items"]
                let site_events = flow_results["site_events"]

                io.write("  âœ“ Flow '", current_flow.name, "' completed.\n")
                io.write("    Scraped ", array.length(scraped_items), " items.\n")
                io.write("    Captured ", array.length(site_events), " events.\n")

                if array.length(scraped_items) > 0 {
                    io.write("    First scraped item: ", json.stringify(scraped_items[0]), "\n")
                }
            } else {
                io.write_error("  âŒ Flow '", current_flow.name, "' failed.\n")
            }
            io.write("\n")
            flow_index = flow_index + 1
        }
        io.write("âœ… All automation flows completed.\n\n")

    } catch (e) {
        io.write_error("âŒ A critical error occurred during execution: ", e, "\n")
    } finally {
        if browser_context_id != null {
            io.write(" shutting down browser...\n")
            if scraper.close_browser(browser_context_id) {
                io.write("âœ“ Browser shut down cleanly.\n")
            } else {
                io.write_error("âŒ Failed to shut down browser.\n")
            }
        }
    }
}
